# Deployment Guide - Render.com

This guide explains how to deploy the Planning Engine application to Render.com with automated GitHub Actions deployment.

## Architecture

The application consists of two services:
- **Backend API**: FastAPI application serving the planning engine API
- **Frontend Web**: Vue.js static site for the user interface

## Initial Setup on Render.com

### 1. Create a Render Account
- Go to [render.com](https://render.com) and sign up/login
- Connect your GitHub account to Render

### 2. Deploy Using Blueprint (Recommended)

The easiest way is to use the `render.yaml` blueprint:

1. Go to your Render Dashboard
2. Click "New" → "Blueprint"
3. Connect your GitHub repository
4. Render will automatically detect `render.yaml` and create both services
5. Click "Apply" to create the services

### 3. Manual Service Creation (Alternative)

If you prefer to create services manually:

#### Backend API Service
1. Click "New" → "Web Service"
2. Connect your GitHub repository
3. Configure:
   - **Name**: `planning-engine-api`
   - **Runtime**: Python 3
   - **Build Command**: `pip install -e . && pip install uvicorn`
   - **Start Command**: `uvicorn apps.api.main:app --host 0.0.0.0 --port $PORT`
   - **Plan**: Free
   - **Environment Variables**:
     - `PYTHON_VERSION`: 3.13.0

#### Frontend Web Service
1. Click "New" → "Static Site"
2. Connect your GitHub repository
3. Configure:
   - **Name**: `planning-engine-web`
   - **Build Command**: `cd apps/web && npm install && npm run build`
   - **Publish Directory**: `./apps/web/dist`
   - **Plan**: Free
   - **Environment Variables**:
     - `NODE_VERSION`: 20.11.0
     - `VITE_API_URL`: `https://planning-engine-api.onrender.com` (use your actual API URL)

## GitHub Actions Automated Deployment

### Setup Instructions

1. **Get Render API Key**:
   - Go to Render Dashboard → Account Settings → API Keys
   - Create a new API key
   - Copy the key (you won't see it again!)

2. **Get Service IDs**:
   - Go to each service's Settings page
   - Copy the Service ID from the URL or settings
   - API Service ID: Found in `planning-engine-api` settings
   - Web Service ID: Found in `planning-engine-web` settings

3. **Add GitHub Secrets**:
   - Go to your GitHub repository
   - Navigate to Settings → Secrets and variables → Actions
   - Click "New repository secret" and add:
     - `RENDER_API_KEY`: Your Render API key
     - `RENDER_API_SERVICE_ID`: Your API service ID
     - `RENDER_WEB_SERVICE_ID`: Your web service ID

4. **Enable GitHub Actions**:
   - The workflow file is already created at `.github/workflows/deploy.yml`
   - Push to the `main` branch to trigger automatic deployment
   - Or manually trigger from GitHub Actions tab

### How It Works

When you push to the `main` branch:
1. GitHub Actions workflow is triggered
2. The workflow uses Render API to trigger deployments
3. Both API and Web services are deployed automatically
4. You can monitor progress in the Render Dashboard

## Environment Variables

### Backend (API)
- `PYTHON_VERSION`: Python version (3.13.0)
- `PORT`: Auto-generated by Render

### Frontend (Web)
- `NODE_VERSION`: Node.js version (20.11.0)
- `VITE_API_URL`: URL of your backend API (e.g., `https://planning-engine-api.onrender.com`)

**Important**: Update `VITE_API_URL` in the frontend service settings to match your actual API URL after deployment.

## Updating API URL in Frontend

After deploying the backend, you need to update the frontend to point to the correct API URL:

1. Go to your `planning-engine-web` service in Render
2. Navigate to Environment
3. Update `VITE_API_URL` to your actual API URL
4. Trigger a manual deploy to rebuild with the new URL

Alternatively, update the `render.yaml` file with your actual API URL and redeploy.

## Testing Your Deployment

### Backend API
- Visit: `https://planning-engine-api.onrender.com/docs`
- You should see the FastAPI Swagger documentation
- Test the endpoints directly from the Swagger UI

### Frontend Web
- Visit: `https://planning-engine-web.onrender.com`
- The Vue.js application should load
- Test the full workflow: upload Excel → geocode → plan routes

## Monitoring and Logs

- **Logs**: View real-time logs in each service's "Logs" tab
- **Metrics**: Monitor performance in the "Metrics" tab
- **Events**: Check deployment history in the "Events" tab

## Free Tier Limitations

Render's free tier includes:
- Services spin down after 15 minutes of inactivity
- First request after spin-down may take 30-60 seconds
- 750 hours/month of runtime per service
- Limited bandwidth and build minutes

For production use, consider upgrading to a paid plan.

## Troubleshooting

### Build Failures
- Check the build logs in Render Dashboard
- Ensure all dependencies are listed in `requirements.txt` and `package.json`
- Verify Python version compatibility (3.13+)

### API Connection Issues
- Verify `VITE_API_URL` is set correctly in frontend
- Check CORS settings if needed
- Ensure API service is running (check logs)

### Service Won't Start
- Check start command is correct
- Verify environment variables are set
- Review application logs for errors

## Local Development

To test locally before deploying:

```bash
# Backend
cd /path/to/planning-engine
pip install -e .
uvicorn apps.api.main:app --reload

# Frontend
cd apps/web
npm install
npm run dev
```

## Support

For issues with:
- **Render Platform**: Check [Render Docs](https://render.com/docs) or contact Render support
- **Application Code**: Review application logs and error messages
- **GitHub Actions**: Check workflow runs in the Actions tab

## Security Notes

- Never commit API keys or secrets to the repository
- Use GitHub Secrets for sensitive data
- Rotate API keys periodically
- Review Render's security best practices
